{"version":3,"sources":["../../../../../src/elements/content-sidebar/activity-feed/annotation-thread/useAnnotationThread.js"],"names":["React","uniqueId","commonMessages","annotationErrors","commentsErrors","API","useRepliesAPI","useAnnotatorEvents","useAnnotationAPI","normalizeReplies","repliesArray","reduce","prevValues","reply","id","denormalizeReplies","repliesMap","Object","keys","map","key","useAnnotationThread","annotationId","api","currentUser","errorCallback","eventEmitter","file","onAnnotationCreate","target","useState","annotation","setAnnotation","replies","setReplies","error","setError","isLoading","setIsLoading","file_version","fileVersionId","fileId","permissions","filePermissions","updateOrCreateReplyItem","replyId","updatedReplyValues","prevReplies","removeReplyItem","newReplies","addPendingReply","baseReply","requestId","date","Date","toISOString","pendingReply","created_at","created_by","isPending","modified_at","isCurrentAnnotation","handleAnnotationUpdateStartEvent","updatedAnnotation","prevAnnotation","handleAnnotationUpdateEndEvent","handleAnnotationDeleteStartEvent","originAnnotationId","handleAnnotationReplyAddStartEvent","handleAnnotationReplyAddEndEvent","handleAnnotationReplyUpdateStart","handleAnnotationReplyUpdateEnd","handleAnnotationReplyDeleteStart","handleAnnotationReplyDeleteEnd","onAnnotationDeleteStart","onAnnotationReplyAddEnd","onAnnotationReplyAddStart","onAnnotationReplyUpdateEnd","onAnnotationReplyUpdateStart","onAnnotationUpdateEnd","onAnnotationUpdateStart","onAnnotationReplyDeleteEnd","onAnnotationReplyDeleteStart","emitAddAnnotationEndEvent","emitAddAnnotationReplyEndEvent","emitAddAnnotationReplyStartEvent","emitAddAnnotationStartEvent","emitAnnotationActiveChangeEvent","emitDeleteAnnotationEndEvent","emitDeleteAnnotationReplyEndEvent","emitDeleteAnnotationReplyStartEvent","emitDeleteAnnotationStartEvent","emitUpdateAnnotationEndEvent","emitUpdateAnnotationReplyEndEvent","emitUpdateAnnotationReplyStartEvent","emitUpdateAnnotationStartEvent","handleUpdateAnnotation","updatedValues","annotationErrorCallback","useCallback","e","code","title","errorOccured","message","default","handleCreate","handleDelete","handleEdit","handleFetch","handleStatusChange","replyErrorCallback","createReply","deleteReply","editReply","handleAnnotationCreate","text","successCallback","newAnnotation","payload","description","handleAnnotationDelete","annotationDeleteSuccessCallback","onAnnotationEditSuccessCallback","handleAnnotationEdit","handleAnnotationStatusChange","status","handleReplyCreate","replyData","tagged_message","type","comment","handleReplyEdit","hasMention","updates","handleReplyDelete","useEffect","fetchedReplies","normalizedAnnotation","undefined","annotationActions","repliesActions"],"mappings":"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","sourcesContent":["// @flow\n\nimport React from 'react';\nimport uniqueId from 'lodash/uniqueId';\nimport type EventEmitter from 'events';\nimport commonMessages from '../../../common/messages';\nimport { annotationErrors, commentsErrors } from './errors';\nimport API from '../../../../api/APIFactory';\nimport useRepliesAPI from './useRepliesAPI';\nimport { useAnnotatorEvents } from '../../../common/annotator-context';\nimport useAnnotationAPI from './useAnnotationAPI';\nimport type { Annotation, AnnotationPermission, NewAnnotation, Target } from '../../../../common/types/annotations';\nimport type { BoxItem, User } from '../../../../common/types/core';\nimport type { BoxCommentPermission, Comment, FeedItemStatus } from '../../../../common/types/feed';\nimport type { ElementOrigin, ElementsXhrError } from '../../../../common/types/api';\nimport type { AnnotationThreadError } from './types';\nimport type { OnAnnotationEdit } from '../comment/types';\n\nconst normalizeReplies = (repliesArray?: Array<Comment>): { [string]: Comment } => {\n    if (!repliesArray) {\n        return {};\n    }\n    return repliesArray.reduce((prevValues, reply) => {\n        return {\n            ...prevValues,\n            [reply.id]: reply,\n        };\n    }, {});\n};\n\nconst denormalizeReplies = (repliesMap: { [string]: Comment }): Array<Comment> => {\n    return Object.keys(repliesMap).map(key => repliesMap[key]);\n};\n\ntype Props = {\n    annotationId?: string,\n    api: API,\n    currentUser: User,\n    errorCallback: (\n        error: ElementsXhrError | Error,\n        code: string,\n        contextInfo?: Object,\n        origin?: ElementOrigin,\n    ) => void,\n    eventEmitter: EventEmitter,\n    file: BoxItem,\n    onAnnotationCreate: (annotation: Annotation) => void,\n    target: Target,\n};\n\ntype UseAnnotationThread = {\n    annotation?: Annotation,\n    annotationActions: {\n        handleAnnotationCreate: (text: string) => void,\n        handleAnnotationDelete: ({ id: string, permissions: AnnotationPermission }) => void,\n        handleAnnotationEdit: OnAnnotationEdit,\n        handleAnnotationStatusChange: (id: string, status: FeedItemStatus, permissions: AnnotationPermission) => void,\n    },\n    error?: AnnotationThreadError,\n    isLoading: boolean,\n    replies: Array<Comment>,\n    repliesActions: {\n        handleReplyCreate: (message: string) => void,\n        handleReplyDelete: ({ id: string, permissions: BoxCommentPermission }) => void,\n        handleReplyEdit: (\n            replyId: string,\n            message: string,\n            status?: FeedItemStatus,\n            hasMention?: boolean,\n            permissions: BoxCommentPermission,\n        ) => void,\n    },\n};\n\nconst useAnnotationThread = ({\n    annotationId,\n    api,\n    currentUser,\n    errorCallback,\n    eventEmitter,\n    file,\n    onAnnotationCreate,\n    target,\n}: Props): UseAnnotationThread => {\n    const [annotation, setAnnotation] = React.useState<Annotation | typeof undefined>();\n    const [replies, setReplies] = React.useState<{ [string]: Comment }>({});\n    const [error, setError] = React.useState<AnnotationThreadError | typeof undefined>();\n    const [isLoading, setIsLoading] = React.useState<boolean>(false);\n\n    const { file_version: { id: fileVersionId } = {}, id: fileId, permissions: filePermissions = {} } = file;\n\n    const updateOrCreateReplyItem = (replyId: string, updatedReplyValues: Object) => {\n        setReplies(prevReplies => ({\n            ...prevReplies,\n            [replyId]: {\n                ...prevReplies[replyId],\n                ...updatedReplyValues,\n            },\n        }));\n    };\n\n    const removeReplyItem = (replyId: string) => {\n        setReplies(prevReplies => {\n            const newReplies = { ...prevReplies };\n            delete newReplies[replyId];\n            return newReplies;\n        });\n    };\n\n    const addPendingReply = (baseReply: Object, requestId: string) => {\n        const date = new Date().toISOString();\n        const pendingReply: Comment = {\n            created_at: date,\n            created_by: currentUser,\n            id: requestId,\n            isPending: true,\n            modified_at: date,\n            ...baseReply,\n        };\n        updateOrCreateReplyItem(requestId, pendingReply);\n    };\n\n    const isCurrentAnnotation = (id: string) => annotationId === id;\n\n    const handleAnnotationUpdateStartEvent = (updatedAnnotation: Annotation) => {\n        if (!isCurrentAnnotation(updatedAnnotation.id) || !annotation) {\n            return;\n        }\n        setAnnotation(prevAnnotation => ({ ...prevAnnotation, ...updatedAnnotation, isPending: true }));\n    };\n\n    const handleAnnotationUpdateEndEvent = (updatedAnnotation: Annotation) => {\n        if (!isCurrentAnnotation(updatedAnnotation.id) || !annotation) {\n            return;\n        }\n        setAnnotation(prevAnnotation => ({ ...prevAnnotation, ...updatedAnnotation, isPending: false }));\n    };\n\n    const handleAnnotationDeleteStartEvent = (originAnnotationId: string) => {\n        if (!isCurrentAnnotation(originAnnotationId) || !annotation) {\n            return;\n        }\n        setAnnotation(prevAnnotation => ({ ...prevAnnotation, isPending: true }));\n    };\n\n    const handleAnnotationReplyAddStartEvent = ({ annotationId: originAnnotationId, reply, requestId }) => {\n        if (!isCurrentAnnotation(originAnnotationId)) {\n            return;\n        }\n        addPendingReply(reply, requestId);\n    };\n\n    const handleAnnotationReplyAddEndEvent = ({ annotationId: originAnnotationId, reply, requestId }) => {\n        if (!isCurrentAnnotation(originAnnotationId)) {\n            return;\n        }\n        updateOrCreateReplyItem(requestId, { ...reply, isPending: false });\n    };\n\n    const handleAnnotationReplyUpdateStart = ({ annotationId: originAnnotationId, reply }) => {\n        if (!isCurrentAnnotation(originAnnotationId)) {\n            return;\n        }\n        updateOrCreateReplyItem(reply.id, { ...reply, isPending: true });\n    };\n\n    const handleAnnotationReplyUpdateEnd = ({ annotationId: originAnnotationId, reply }) => {\n        if (!isCurrentAnnotation(originAnnotationId)) {\n            return;\n        }\n        updateOrCreateReplyItem(reply.id, { ...reply, isPending: false });\n    };\n\n    const handleAnnotationReplyDeleteStart = ({ annotationId: originAnnotationId, id: replyId }) => {\n        if (!isCurrentAnnotation(originAnnotationId)) {\n            return;\n        }\n        updateOrCreateReplyItem(replyId, { isPending: true });\n    };\n\n    const handleAnnotationReplyDeleteEnd = ({ annotationId: originAnnotationId, id: replyId }) => {\n        if (!isCurrentAnnotation(originAnnotationId)) {\n            return;\n        }\n        removeReplyItem(replyId);\n    };\n\n    const {\n        emitAddAnnotationEndEvent,\n        emitAddAnnotationReplyEndEvent,\n        emitAddAnnotationReplyStartEvent,\n        emitAddAnnotationStartEvent,\n        emitAnnotationActiveChangeEvent,\n        emitDeleteAnnotationEndEvent,\n        emitDeleteAnnotationReplyEndEvent,\n        emitDeleteAnnotationReplyStartEvent,\n        emitDeleteAnnotationStartEvent,\n        emitUpdateAnnotationEndEvent,\n        emitUpdateAnnotationReplyEndEvent,\n        emitUpdateAnnotationReplyStartEvent,\n        emitUpdateAnnotationStartEvent,\n    } = useAnnotatorEvents({\n        eventEmitter,\n        onAnnotationDeleteStart: handleAnnotationDeleteStartEvent,\n        onAnnotationReplyAddEnd: handleAnnotationReplyAddEndEvent,\n        onAnnotationReplyAddStart: handleAnnotationReplyAddStartEvent,\n        onAnnotationReplyUpdateEnd: handleAnnotationReplyUpdateEnd,\n        onAnnotationReplyUpdateStart: handleAnnotationReplyUpdateStart,\n        onAnnotationUpdateEnd: handleAnnotationUpdateEndEvent,\n        onAnnotationUpdateStart: handleAnnotationUpdateStartEvent,\n        onAnnotationReplyDeleteEnd: handleAnnotationReplyDeleteEnd,\n        onAnnotationReplyDeleteStart: handleAnnotationReplyDeleteStart,\n    });\n\n    const handleUpdateAnnotation = (updatedValues: Object) => {\n        setAnnotation(prevAnnotation => ({ ...prevAnnotation, ...updatedValues }));\n    };\n\n    const annotationErrorCallback = React.useCallback(\n        (e: ElementsXhrError, code: string): void => {\n            setIsLoading(false);\n            setError({\n                title: commonMessages.errorOccured,\n                message: annotationErrors[code] || annotationErrors.default,\n            });\n\n            errorCallback(e, code, {\n                error: e,\n            });\n        },\n        [errorCallback],\n    );\n\n    const { handleCreate, handleDelete, handleEdit, handleFetch, handleStatusChange } = useAnnotationAPI({\n        api,\n        file,\n        errorCallback: annotationErrorCallback,\n    });\n\n    const replyErrorCallback = React.useCallback(\n        (replyId: string, e: ElementsXhrError, code: string): void => {\n            updateOrCreateReplyItem(replyId, {\n                error: {\n                    title: commonMessages.errorOccured,\n                    message: commentsErrors[code] || commentsErrors.default,\n                },\n            });\n\n            errorCallback(e, code, {\n                error: e,\n            });\n        },\n        [errorCallback],\n    );\n\n    const { createReply, deleteReply, editReply } = useRepliesAPI({\n        annotationId,\n        api,\n        errorCallback: replyErrorCallback,\n        fileId,\n        filePermissions,\n    });\n\n    const handleAnnotationCreate = (text: string) => {\n        setIsLoading(true);\n\n        const requestId = uniqueId('annotation_');\n\n        const successCallback = (newAnnotation: Annotation) => {\n            setIsLoading(false);\n            emitAddAnnotationEndEvent(newAnnotation, requestId);\n            onAnnotationCreate(newAnnotation);\n        };\n\n        const payload: NewAnnotation = {\n            description: { message: text },\n            target,\n        };\n\n        emitAddAnnotationStartEvent(payload, requestId);\n\n        handleCreate({ payload, successCallback });\n    };\n\n    const handleAnnotationDelete = ({ id, permissions }: { id: string, permissions: AnnotationPermission }): void => {\n        const annotationDeleteSuccessCallback = () => {\n            emitDeleteAnnotationEndEvent(id);\n        };\n\n        setAnnotation(prevAnnotation => ({ ...prevAnnotation, isPending: true }));\n\n        emitDeleteAnnotationStartEvent(id);\n\n        handleDelete({\n            id,\n            permissions,\n            successCallback: annotationDeleteSuccessCallback,\n        });\n    };\n\n    const onAnnotationEditSuccessCallback = (updatedAnnotation: Annotation): void => {\n        handleUpdateAnnotation({\n            ...updatedAnnotation,\n            isPending: false,\n        });\n\n        emitUpdateAnnotationEndEvent(updatedAnnotation);\n    };\n\n    const handleAnnotationEdit = ({ id, text, permissions }): void => {\n        setAnnotation(prevAnnotation => ({ ...prevAnnotation, isPending: true }));\n\n        emitUpdateAnnotationStartEvent({\n            id,\n            description: { message: text },\n        });\n\n        handleEdit({\n            id,\n            text: text ?? '',\n            permissions,\n            successCallback: onAnnotationEditSuccessCallback,\n        });\n    };\n\n    const handleAnnotationStatusChange = (\n        id: string,\n        status: FeedItemStatus,\n        permissions: AnnotationPermission,\n    ): void => {\n        setAnnotation(prevAnnotation => ({ ...prevAnnotation, isPending: true }));\n\n        handleStatusChange({\n            id,\n            status,\n            permissions,\n            successCallback: onAnnotationEditSuccessCallback,\n        });\n    };\n\n    const handleReplyCreate = (message: string) => {\n        const requestId = uniqueId('reply_');\n        const replyData = {\n            tagged_message: message,\n            type: 'comment',\n        };\n\n        const successCallback = (comment: Comment) => {\n            updateOrCreateReplyItem(requestId, { ...comment, isPending: false });\n            emitAddAnnotationReplyEndEvent(comment, annotationId, requestId);\n        };\n\n        addPendingReply(replyData, requestId);\n        emitAddAnnotationReplyStartEvent(replyData, annotationId, requestId);\n\n        createReply({ message, requestId, successCallback });\n    };\n\n    const handleReplyEdit = (\n        replyId: string,\n        message: string,\n        status?: FeedItemStatus,\n        hasMention?: boolean,\n        permissions: BoxCommentPermission,\n    ) => {\n        const updates = {\n            id: replyId,\n            tagged_message: message,\n        };\n\n        const successCallback = (comment: Comment) => {\n            updateOrCreateReplyItem(comment.id, { ...comment, isPending: false });\n            emitUpdateAnnotationReplyEndEvent(comment, annotationId);\n        };\n\n        updateOrCreateReplyItem(replyId, { message, isPending: true });\n        emitUpdateAnnotationReplyStartEvent(updates, annotationId);\n\n        editReply({ id: replyId, message, permissions, successCallback });\n    };\n\n    const handleReplyDelete = ({ id, permissions }: { id: string, permissions: BoxCommentPermission }) => {\n        updateOrCreateReplyItem(id, { isPending: true });\n        emitDeleteAnnotationReplyStartEvent(id, annotationId);\n\n        const successCallback = () => {\n            removeReplyItem(id);\n            emitDeleteAnnotationReplyEndEvent(id, annotationId);\n        };\n\n        deleteReply({ id, permissions, successCallback });\n    };\n\n    React.useEffect(() => {\n        if (!annotationId || isLoading || (annotation && annotation.id === annotationId)) {\n            return;\n        }\n        setIsLoading(true);\n        handleFetch({\n            id: annotationId,\n            successCallback: ({ replies: fetchedReplies, ...normalizedAnnotation }: Annotation) => {\n                setAnnotation({ ...normalizedAnnotation });\n                setReplies(normalizeReplies(fetchedReplies));\n                setError(undefined);\n                setIsLoading(false);\n                emitAnnotationActiveChangeEvent(normalizedAnnotation.id, fileVersionId);\n            },\n        });\n    }, [annotation, annotationId, emitAnnotationActiveChangeEvent, fileVersionId, handleFetch, isLoading]);\n\n    return {\n        annotation,\n        error,\n        isLoading,\n        replies: denormalizeReplies(replies),\n        annotationActions: {\n            handleAnnotationCreate,\n            handleAnnotationDelete,\n            handleAnnotationEdit,\n            handleAnnotationStatusChange,\n        },\n        repliesActions: {\n            handleReplyCreate,\n            handleReplyEdit,\n            handleReplyDelete,\n        },\n    };\n};\n\nexport default useAnnotationThread;\n"],"file":"useAnnotationThread.js"}